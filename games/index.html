---
layout: default
title: Games
---

<style>
  .games-page {
    --games-bg: #f6efe3;
    --games-surface: #fffaf0;
    --games-border: #e0d5c2;
    --games-text: #2b2a28;
    --games-muted: #665f56;
    --games-accent: #d56d2a;
    --games-accent-soft: #f3d4b6;
    --games-sky-top: #8cc8f5;
    --games-sky-bottom: #f8f0d2;
    margin-top: 0.75rem;
    color: var(--games-text);
    animation: games-fade-in 0.5s ease-out;
  }

  html.dark .games-page {
    --games-bg: #1f1a15;
    --games-surface: #2a241e;
    --games-border: #3a3128;
    --games-text: #f2e8da;
    --games-muted: #baa892;
    --games-accent: #f0964f;
    --games-accent-soft: #513828;
    --games-sky-top: #273145;
    --games-sky-bottom: #4e3f33;
  }

  @keyframes games-fade-in {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .games-hero {
    position: relative;
    isolation: isolate;
    overflow: hidden;
    background: radial-gradient(circle at 14% 12%, rgba(255,255,255,0.75), transparent 40%),
                radial-gradient(circle at 82% 22%, rgba(240, 150, 79, 0.22), transparent 36%),
                linear-gradient(165deg, var(--games-accent-soft), var(--games-bg));
    border: 1px solid var(--games-border);
    border-radius: 16px;
    padding: 1.2rem 1.25rem 1.35rem;
    box-shadow: 0 12px 30px rgba(0,0,0,0.12);
  }

  .games-hero::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(120deg, rgba(255,255,255,0.16) 0, rgba(255,255,255,0) 45%),
                repeating-linear-gradient(90deg, rgba(255,255,255,0.05), rgba(255,255,255,0.05) 1px, transparent 1px, transparent 24px);
    pointer-events: none;
  }

  .games-hero::after {
    content: '';
    position: absolute;
    left: -6%;
    right: -6%;
    bottom: -34px;
    height: 74px;
    background: radial-gradient(90px 34px at 12% 100%, rgba(67, 118, 66, 0.5), transparent 60%),
                radial-gradient(100px 36px at 34% 100%, rgba(56, 102, 61, 0.45), transparent 60%),
                radial-gradient(120px 36px at 58% 100%, rgba(67, 118, 66, 0.5), transparent 60%),
                radial-gradient(100px 34px at 80% 100%, rgba(56, 102, 61, 0.45), transparent 60%);
    pointer-events: none;
  }

  .games-hero-inner {
    position: relative;
    z-index: 3;
    display: flex;
    flex-direction: column;
    gap: 0.65rem;
  }

  .games-night-glow,
  .games-lantern,
  .games-fireflies {
    display: none;
  }

  .games-kicker {
    align-self: flex-start;
    font-family: 'JetBrains Mono', monospace;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.68rem;
    font-weight: 700;
    border: 1px solid var(--games-border);
    color: var(--games-muted);
    border-radius: 999px;
    background: rgba(255,255,255,0.45);
    padding: 0.2rem 0.6rem;
  }

  .games-title {
    margin: 0;
    font-size: 2.1rem;
    line-height: 1.2;
    text-shadow: 0 2px 0 rgba(255,255,255,0.35), 0 10px 18px rgba(0,0,0,0.15);
  }

  .games-copy {
    margin: 0;
    color: var(--games-muted);
    font-size: 1rem;
    max-width: 46ch;
  }

  .games-hero-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.45rem;
  }

  .games-hero-chip {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    border: 1px solid var(--games-border);
    color: var(--games-text);
    border-radius: 7px;
    background: rgba(255,255,255,0.5);
    padding: 0.2rem 0.45rem;
  }

  html.dark .games-kicker,
  html.dark .games-hero-chip {
    background: rgba(0,0,0,0.2);
  }

  html.dark .games-hero {
    background: radial-gradient(circle at 80% 18%, rgba(240, 150, 79, 0.16), transparent 40%),
                radial-gradient(circle at 18% 14%, rgba(132, 174, 255, 0.12), transparent 34%),
                linear-gradient(160deg, #27201a, #1b1714 62%, #2a1f17);
    border-color: #463a2f;
    box-shadow: 0 12px 28px rgba(0,0,0,0.35);
  }

  html.dark .games-hero::before {
    background: linear-gradient(120deg, rgba(255,255,255,0.05) 0, rgba(255,255,255,0) 48%),
                repeating-linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.03) 1px, transparent 1px, transparent 26px);
  }

  html.dark .games-hero::after {
    background: radial-gradient(90px 34px at 12% 100%, rgba(47, 82, 47, 0.38), transparent 60%),
                radial-gradient(100px 36px at 34% 100%, rgba(39, 69, 43, 0.34), transparent 60%),
                radial-gradient(120px 36px at 58% 100%, rgba(47, 82, 47, 0.38), transparent 60%),
                radial-gradient(100px 34px at 80% 100%, rgba(39, 69, 43, 0.34), transparent 60%);
  }

  html.dark .games-title {
    text-shadow: 0 2px 0 rgba(0,0,0,0.38), 0 8px 16px rgba(0,0,0,0.45);
  }

  html.dark .games-kicker {
    color: #c7b197;
    border-color: #5a4c3e;
    background: rgba(0,0,0,0.28);
  }

  html.dark .games-hero-chip {
    color: #e6d7c4;
    border-color: #574838;
    background: rgba(0,0,0,0.24);
  }

  html.dark .games-night-glow {
    display: block;
    position: absolute;
    inset: 0;
    z-index: 1;
    pointer-events: none;
    background: radial-gradient(circle at 83% 22%, rgba(243, 170, 90, 0.2), transparent 34%),
                radial-gradient(circle at 18% 14%, rgba(132, 174, 255, 0.09), transparent 32%);
    animation: games-night-breathe 6s ease-in-out infinite;
  }

  html.dark .games-lantern {
    display: block;
    position: absolute;
    right: 1.2rem;
    top: 0.7rem;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    z-index: 2;
    pointer-events: none;
    background: radial-gradient(circle, #ffd694 0, #ee9e4d 58%, #a5582d 100%);
    box-shadow: 0 0 0 2px rgba(60, 38, 24, 0.45), 0 0 14px rgba(240, 157, 80, 0.58), 0 0 26px rgba(240, 157, 80, 0.4);
    animation: games-lantern-sway 2.4s ease-in-out infinite;
  }

  html.dark .games-lantern::before {
    content: '';
    position: absolute;
    left: 50%;
    bottom: 100%;
    width: 2px;
    height: 12px;
    transform: translateX(-50%);
    background: rgba(180, 150, 120, 0.5);
  }

  html.dark .games-lantern::after {
    content: '';
    position: absolute;
    left: 50%;
    top: 3px;
    width: 40px;
    height: 40px;
    transform: translateX(-50%);
    border-radius: 50%;
    background: radial-gradient(circle, rgba(245, 164, 88, 0.28), rgba(245, 164, 88, 0));
  }

  html.dark .games-fireflies {
    display: block;
    position: absolute;
    inset: 0;
    z-index: 2;
    pointer-events: none;
  }

  html.dark .games-fireflies::before,
  html.dark .games-fireflies::after {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-image: radial-gradient(circle, rgba(255, 211, 140, 0.85) 0 1px, transparent 1px),
                      radial-gradient(circle, rgba(255, 195, 120, 0.7) 0 1px, transparent 1px),
                      radial-gradient(circle, rgba(255, 220, 160, 0.55) 0 1.5px, transparent 1.5px);
    background-size: 160px 100%, 220px 100%, 300px 100%;
    background-position: 0 0, 40px 0, 80px 0;
    opacity: 0.35;
  }

  html.dark .games-fireflies::before {
    animation: games-firefly-drift 9s linear infinite;
  }

  html.dark .games-fireflies::after {
    opacity: 0.22;
    animation: games-firefly-drift 14s linear infinite reverse;
  }

  @keyframes games-lantern-sway {
    0%, 100% { transform: rotate(-3deg) translateY(0); }
    50% { transform: rotate(3deg) translateY(1px); }
  }

  @keyframes games-firefly-drift {
    0% { transform: translateX(0); }
    100% { transform: translateX(-120px); }
  }

  @keyframes games-night-breathe {
    0%, 100% { opacity: 0.82; }
    50% { opacity: 1; }
  }

  .games-shell {
    margin-top: 1rem;
    border-radius: 14px;
    overflow: hidden;
    border: 1px solid var(--games-border);
    background: var(--games-surface);
    box-shadow: 0 10px 22px rgba(0, 0, 0, 0.1);
  }

  .games-toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    justify-content: space-between;
    align-items: center;
    padding: 0.65rem 0.9rem;
    border-bottom: 1px solid var(--games-border);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.8rem;
    color: var(--games-muted);
  }

  .games-pill {
    border: 1px solid var(--games-border);
    border-radius: 999px;
    padding: 0.2rem 0.6rem;
    background: var(--games-bg);
  }

  #maple-run {
    width: 100%;
    height: auto;
    display: block;
    background: linear-gradient(180deg, var(--games-sky-top), var(--games-sky-bottom));
  }

  .games-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.9rem;
    font-size: 0.85rem;
    color: var(--games-muted);
  }

  .games-controls kbd {
    border: 1px solid var(--games-border);
    border-bottom-width: 2px;
    border-radius: 6px;
    padding: 0.1rem 0.35rem;
    background: var(--games-surface);
    color: var(--games-text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
  }

  .games-mobile-jump {
    position: absolute;
    right: 0.9rem;
    bottom: 0.9rem;
    border: 0;
    border-radius: 999px;
    width: 68px;
    height: 68px;
    background: rgba(240, 150, 79, 0.85);
    color: #fff;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 700;
    letter-spacing: 0.04em;
    box-shadow: 0 8px 18px rgba(0,0,0,0.22);
    display: none;
  }

  .games-canvas-wrap {
    position: relative;
  }

  @media (max-width: 800px) {
    .games-title { font-size: 1.65rem; }
    .games-toolbar { font-size: 0.72rem; }
    .games-mobile-jump { display: block; }
    .games-copy { font-size: 0.95rem; }
  }
</style>

<section class="games-page">
  <div class="games-hero">
    <span class="games-night-glow" aria-hidden="true"></span>
    <span class="games-lantern" aria-hidden="true"></span>
    <span class="games-fireflies" aria-hidden="true"></span>
    <div class="games-hero-inner">
      <span class="games-kicker">Arcade Lab</span>
      <h1 class="games-title">Maple Runner</h1>
      <p class="games-copy">A tiny side-scroller inspired by MapleStory: jump between platforms, collect maple leaves, and dodge slimes.</p>
      <div class="games-hero-meta">
        <span class="games-hero-chip">Canvas side-scroller</span>
        <span class="games-hero-chip">Double jump</span>
        <span class="games-hero-chip">Local high score</span>
      </div>
    </div>
  </div>

  <div class="games-shell">
    <div class="games-toolbar">
      <span class="games-pill">Score: <strong id="hud-score">0</strong></span>
      <span class="games-pill">Best: <strong id="hud-best">0</strong></span>
      <span class="games-pill" id="hud-state">Running</span>
    </div>
    <div class="games-canvas-wrap">
      <canvas id="maple-run" width="960" height="420" aria-label="Maple Runner game"></canvas>
      <button class="games-mobile-jump" id="mobile-jump" type="button">Jump</button>
    </div>
  </div>

  <div class="games-controls">
    <span><kbd>Space</kbd>/<kbd>W</kbd>/<kbd>Up</kbd> Jump (double jump enabled)</span>
    <span><kbd>P</kbd> Pause</span>
    <span><kbd>R</kbd> Restart</span>
  </div>
</section>

<script>
(function () {
  var canvas = document.getElementById('maple-run');
  var ctx = canvas.getContext('2d');
  var scoreEl = document.getElementById('hud-score');
  var bestEl = document.getElementById('hud-best');
  var stateEl = document.getElementById('hud-state');
  var jumpBtn = document.getElementById('mobile-jump');

  var W = canvas.width;
  var H = canvas.height;
  var groundY = 334;
  var gravity = 1700;
  var speed = 210;
  var frame = 0;
  var score = 0;
  var best = parseInt(localStorage.getItem('maple-run-best') || '0', 10);
  var gameOver = false;
  var paused = false;
  var rngSeed = 3;

  var clouds = [];
  var platforms = [];
  var slimes = [];
  var leaves = [];
  var puffs = [];
  var motes = [];

  var player = {
    x: 180,
    y: groundY - 58,
    w: 34,
    h: 48,
    vy: 0,
    jumps: 0,
    invuln: 0
  };

  function rand() {
    rngSeed = (rngSeed * 9301 + 49297) % 233280;
    return rngSeed / 233280;
  }

  function resetWorld() {
    score = 0;
    speed = 210;
    frame = 0;
    gameOver = false;
    paused = false;
    stateEl.textContent = 'Running';
    player.x = 180;
    player.y = groundY - player.h;
    player.vy = 0;
    player.jumps = 0;
    player.invuln = 0;
    clouds = [];
    platforms = [];
    slimes = [];
    leaves = [];
    puffs = [];
    motes = [];

    var i;
    for (i = 0; i < 8; i++) {
      clouds.push({ x: i * 160 + rand() * 80, y: 45 + rand() * 110, s: 0.5 + rand() * 0.8 });
    }

    for (i = 0; i < 3; i++) {
      platforms.push({ x: 380 + i * 250, y: 200 + rand() * 80, w: 130 + rand() * 70, h: 16 });
    }

    for (i = 0; i < 28; i++) {
      motes.push({
        x: rand() * W,
        y: 70 + rand() * 210,
        r: 1 + rand() * 2,
        vx: -12 - rand() * 20,
        vy: -6 + rand() * 12,
        phase: rand() * 6.28
      });
    }
  }

  function spawnSet() {
    var x = W + 40 + rand() * 160;
    var raised = rand() < 0.6;

    if (raised) {
      var p = { x: x, y: 180 + rand() * 110, w: 120 + rand() * 90, h: 16 };
      platforms.push(p);
      if (rand() < 0.8) {
        leaves.push({ x: p.x + p.w * (0.3 + rand() * 0.4), y: p.y - 28, r: 10, got: false, spin: rand() * 6.28 });
      }
    } else {
      slimes.push({ x: x, y: groundY - 26, w: 34, h: 26, t: rand() * 10 });
      if (rand() < 0.65) {
        leaves.push({ x: x + 30 + rand() * 60, y: groundY - 72 - rand() * 40, r: 10, got: false, spin: rand() * 6.28 });
      }
    }

    if (rand() < 0.45) {
      slimes.push({ x: x + 140 + rand() * 100, y: groundY - 26, w: 34, h: 26, t: rand() * 10 });
    }
  }

  function jump() {
    if (gameOver) return;
    if (paused) return;
    if (player.jumps < 2) {
      player.vy = -640;
      player.jumps += 1;
      puffs.push({ x: player.x + 14, y: player.y + player.h, life: 0.35, size: 18 });
    }
  }

  function collide(a, b) {
    return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
  }

  function onTopOfPlatform(prevY, nextY, platform) {
    var wasAbove = prevY + player.h <= platform.y + 3;
    var crossed = nextY + player.h >= platform.y;
    var overlapX = player.x + player.w > platform.x + 6 && player.x < platform.x + platform.w - 6;
    return wasAbove && crossed && overlapX && player.vy >= 0;
  }

  function update(dt) {
    if (paused || gameOver) return;

    frame += dt;
    score += dt * 11;
    speed += dt * 2.2;

    var prevY = player.y;
    player.vy += gravity * dt;
    player.y += player.vy * dt;

    var onSomething = false;
    if (player.y + player.h >= groundY) {
      player.y = groundY - player.h;
      player.vy = 0;
      player.jumps = 0;
      onSomething = true;
    }

    var i;
    for (i = platforms.length - 1; i >= 0; i--) {
      var p = platforms[i];
      p.x -= speed * dt;

      if (onTopOfPlatform(prevY, player.y, p)) {
        player.y = p.y - player.h;
        player.vy = 0;
        player.jumps = 0;
        onSomething = true;
      }

      if (p.x + p.w < -50) {
        platforms.splice(i, 1);
      }
    }

    for (i = slimes.length - 1; i >= 0; i--) {
      var s = slimes[i];
      s.x -= speed * dt;
      s.t += dt * 8;

      if (s.x + s.w < -40) {
        slimes.splice(i, 1);
        continue;
      }

      if (player.invuln <= 0 && collide(player, s)) {
        gameOver = true;
        stateEl.textContent = 'Game Over (R to restart)';
        if (Math.floor(score) > best) {
          best = Math.floor(score);
          localStorage.setItem('maple-run-best', String(best));
        }
      }
    }

    for (i = leaves.length - 1; i >= 0; i--) {
      var leaf = leaves[i];
      leaf.x -= speed * dt;
      leaf.spin += dt * 5;
      var c = { x: leaf.x - leaf.r, y: leaf.y - leaf.r, w: leaf.r * 2, h: leaf.r * 2 };

      if (leaf.x + leaf.r < -20) {
        leaves.splice(i, 1);
        continue;
      }

      if (!leaf.got && collide(player, c)) {
        leaf.got = true;
        score += 30;
        puffs.push({ x: leaf.x, y: leaf.y, life: 0.45, size: 24 });
        leaves.splice(i, 1);
      }
    }

    for (i = puffs.length - 1; i >= 0; i--) {
      puffs[i].life -= dt;
      puffs[i].size += dt * 35;
      if (puffs[i].life <= 0) puffs.splice(i, 1);
    }

    for (i = 0; i < motes.length; i++) {
      var m = motes[i];
      m.x += (m.vx - speed * 0.06) * dt;
      m.y += (m.vy + Math.sin(frame * 2.2 + m.phase) * 7) * dt;
      if (m.x < -20) {
        m.x = W + rand() * 60;
        m.y = 55 + rand() * 220;
      }
      if (m.y < 40) m.y = 40;
      if (m.y > groundY - 20) m.y = groundY - 20;
    }

    for (i = 0; i < clouds.length; i++) {
      clouds[i].x -= (28 + clouds[i].s * 18) * dt;
      if (clouds[i].x < -120) {
        clouds[i].x = W + rand() * 60;
        clouds[i].y = 35 + rand() * 120;
      }
    }

    if (!onSomething && player.y > H + 80) {
      gameOver = true;
      stateEl.textContent = 'Fell off (R to restart)';
    }

    if (player.invuln > 0) {
      player.invuln -= dt;
    }

    if (platforms.length < 4 || slimes.length < 2) {
      if (rand() < 0.02 + Math.min(0.02, frame / 320)) spawnSet();
    }

    scoreEl.textContent = String(Math.floor(score));
    bestEl.textContent = String(best);
  }

  function drawSky() {
    var dark = document.documentElement.classList.contains('dark');
    var sky = ctx.createLinearGradient(0, 0, 0, H);

    if (dark) {
      sky.addColorStop(0, '#121a2e');
      sky.addColorStop(0.58, '#293454');
      sky.addColorStop(1, '#5a4438');
    } else {
      sky.addColorStop(0, '#8fd2ff');
      sky.addColorStop(0.56, '#bde8ff');
      sky.addColorStop(1, '#ffe7bd');
    }

    ctx.fillStyle = sky;
    ctx.fillRect(0, 0, W, H);

    var cx = W * 0.78 + Math.sin(frame * 0.08) * 10;
    var cy = 82 + Math.cos(frame * 0.04) * 3;
    if (dark) {
      ctx.fillStyle = 'rgba(255, 244, 216, 0.88)';
      ctx.beginPath();
      ctx.arc(cx, cy, 30, 0, Math.PI * 2);
      ctx.fill();

      ctx.fillStyle = '#263354';
      ctx.beginPath();
      ctx.arc(cx + 12, cy - 4, 24, 0, Math.PI * 2);
      ctx.fill();

      var i;
      for (i = 0; i < 24; i++) {
        var sx = (i * 97) % W;
        var sy = 20 + (i * 53) % 170;
        var tw = (Math.sin(frame * 4 + i * 0.7) + 1) * 0.5;
        ctx.fillStyle = 'rgba(255,255,255,' + (0.2 + tw * 0.45) + ')';
        ctx.fillRect(sx, sy, 2, 2);
      }
    } else {
      var glow = ctx.createRadialGradient(cx, cy, 14, cx, cy, 72);
      glow.addColorStop(0, 'rgba(255, 236, 162, 0.98)');
      glow.addColorStop(0.45, 'rgba(255, 220, 137, 0.6)');
      glow.addColorStop(1, 'rgba(255, 220, 137, 0)');
      ctx.fillStyle = glow;
      ctx.beginPath();
      ctx.arc(cx, cy, 72, 0, Math.PI * 2);
      ctx.fill();
    }
  }

  function drawCloud(c) {
    ctx.save();
    ctx.translate(c.x, c.y);
    ctx.scale(c.s, c.s);

    ctx.fillStyle = 'rgba(0,0,0,0.12)';
    ctx.beginPath();
    ctx.ellipse(18, 12, 34, 10, 0, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = 'rgba(255,255,255,0.72)';
    ctx.beginPath();
    ctx.arc(0, 2, 16, 0, Math.PI * 2);
    ctx.arc(18, -7, 18, 0, Math.PI * 2);
    ctx.arc(40, 2, 14, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = 'rgba(255,255,255,0.3)';
    ctx.fillRect(-7, -3, 35, 4);
    ctx.restore();
  }

  function drawPines(offset, drift, baseY, scale, color) {
    var i;
    ctx.fillStyle = color;
    for (i = 0; i < 10; i++) {
      var x = i * 120 - ((frame * drift) % 120) + offset;
      var h = (34 + (i % 4) * 9) * scale;
      ctx.beginPath();
      ctx.moveTo(x, baseY);
      ctx.lineTo(x + 12 * scale, baseY - h);
      ctx.lineTo(x + 24 * scale, baseY);
      ctx.closePath();
      ctx.fill();
      ctx.fillRect(x + 10 * scale, baseY, 4 * scale, 9 * scale);
    }
  }

  function drawHills() {
    var i;
    ctx.fillStyle = 'rgba(131, 183, 110, 0.35)';
    for (i = 0; i < 7; i++) {
      var x1 = i * 210 - ((frame * 16) % 210) - 50;
      ctx.beginPath();
      ctx.ellipse(x1, 286, 180, 92, 0, Math.PI, 0, true);
      ctx.fill();
    }

    ctx.fillStyle = 'rgba(93, 145, 84, 0.58)';
    for (i = 0; i < 8; i++) {
      var x2 = i * 190 - ((frame * 28) % 190) - 65;
      ctx.beginPath();
      ctx.ellipse(x2, 312, 132, 76, 0, Math.PI, 0, true);
      ctx.fill();
    }

    drawPines(0, 46, 322, 0.9, 'rgba(51, 98, 56, 0.5)');
    drawPines(54, 66, 330, 1.05, 'rgba(37, 74, 45, 0.58)');
  }

  function drawGround() {
    var dirt = ctx.createLinearGradient(0, groundY, 0, H);
    dirt.addColorStop(0, '#a5764d');
    dirt.addColorStop(1, '#765337');
    ctx.fillStyle = dirt;
    ctx.fillRect(0, groundY, W, H - groundY);

    var grass = ctx.createLinearGradient(0, groundY - 10, 0, groundY + 8);
    grass.addColorStop(0, '#7cc65f');
    grass.addColorStop(1, '#4f8f3f');
    ctx.fillStyle = grass;
    ctx.fillRect(0, groundY - 12, W, 12);

    var i;
    for (i = 0; i < 85; i++) {
      var gx = i * 16 - ((frame * speed * 0.23) % 16);
      var blade = 5 + ((i % 3) * 2);
      ctx.strokeStyle = i % 5 === 0 ? '#95d874' : '#67b24e';
      ctx.beginPath();
      ctx.moveTo(gx, groundY - 2);
      ctx.lineTo(gx + (i % 2 ? -2 : 2), groundY - blade);
      ctx.stroke();
    }

    for (i = 0; i < 18; i++) {
      var sx = i * 62 - ((frame * speed * 0.14) % 62);
      ctx.fillStyle = 'rgba(255,255,255,0.09)';
      ctx.fillRect(sx + 8, groundY + 14 + (i % 3) * 10, 20 + (i % 4) * 6, 4);
    }
  }

  function drawPlatform(p) {
    ctx.fillStyle = 'rgba(0,0,0,0.22)';
    ctx.beginPath();
    ctx.ellipse(p.x + p.w * 0.5, p.y + p.h + 8, p.w * 0.35, 7, 0, 0, Math.PI * 2);
    ctx.fill();

    var body = ctx.createLinearGradient(p.x, p.y, p.x, p.y + p.h);
    body.addColorStop(0, '#8a6541');
    body.addColorStop(1, '#624227');
    ctx.fillStyle = body;
    ctx.fillRect(p.x, p.y, p.w, p.h);

    ctx.fillStyle = '#a6d978';
    ctx.fillRect(p.x - 2, p.y - 6, p.w + 4, 6);

    ctx.fillStyle = '#73a24f';
    var i;
    for (i = 0; i < p.w; i += 14) {
      ctx.fillRect(p.x + i, p.y - 9 - ((i / 7) % 2), 2, 3 + ((i / 9) % 3));
    }

    ctx.fillStyle = 'rgba(255,255,255,0.12)';
    ctx.fillRect(p.x + 8, p.y + 4, p.w - 14, 2);
  }

  function drawSlime(s) {
    var bob = Math.sin(s.t) * 1.8;
    ctx.fillStyle = 'rgba(0,0,0,0.24)';
    ctx.beginPath();
    ctx.ellipse(s.x + s.w / 2, s.y + s.h + 2, s.w * 0.42, 5, 0, 0, Math.PI * 2);
    ctx.fill();

    ctx.save();
    ctx.translate(s.x, s.y + bob);

    var slime = ctx.createLinearGradient(0, 0, 0, s.h);
    slime.addColorStop(0, '#89ec9a');
    slime.addColorStop(1, '#3ea85e');
    ctx.fillStyle = slime;
    ctx.beginPath();
    ctx.moveTo(2, s.h);
    ctx.quadraticCurveTo(s.w / 2, -4, s.w - 2, s.h);
    ctx.closePath();
    ctx.fill();

    ctx.fillStyle = 'rgba(255,255,255,0.35)';
    ctx.beginPath();
    ctx.ellipse(12, 9, 6, 3, -0.4, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = '#20462f';
    ctx.fillRect(9, 10, 4, 4);
    ctx.fillRect(21, 10, 4, 4);
    ctx.fillRect(14, 17, 6, 2);

    ctx.fillStyle = '#f3a8ab';
    ctx.fillRect(6, 17, 3, 2);
    ctx.fillRect(25, 17, 3, 2);
    ctx.restore();
  }

  function drawLeaf(leaf) {
    ctx.save();
    ctx.translate(leaf.x, leaf.y);
    ctx.rotate(Math.sin(leaf.spin) * 0.6);

    ctx.fillStyle = 'rgba(255, 169, 85, 0.22)';
    ctx.beginPath();
    ctx.arc(0, 0, leaf.r + 5, 0, Math.PI * 2);
    ctx.fill();

    var lg = ctx.createLinearGradient(-leaf.r, -leaf.r, leaf.r, leaf.r);
    lg.addColorStop(0, '#f7b15d');
    lg.addColorStop(1, '#d86a2a');
    ctx.fillStyle = lg;
    ctx.beginPath();
    ctx.moveTo(0, -leaf.r);
    ctx.lineTo(leaf.r * 0.9, 0);
    ctx.lineTo(0, leaf.r);
    ctx.lineTo(-leaf.r * 0.9, 0);
    ctx.closePath();
    ctx.fill();

    ctx.strokeStyle = 'rgba(80,35,16,0.55)';
    ctx.beginPath();
    ctx.moveTo(0, -leaf.r + 2);
    ctx.lineTo(0, leaf.r - 2);
    ctx.moveTo(0, 0);
    ctx.lineTo(leaf.r * 0.45, 0);
    ctx.stroke();
    ctx.restore();
  }

  function drawPlayer() {
    var blink = Math.floor(frame * 2.6) % 16 === 0;
    var running = Math.abs(player.vy) < 4;
    var bounce = running ? Math.sin(frame * 15) * 1.8 : 0;
    var legPhase = Math.sin(frame * 24) * 2;

    ctx.fillStyle = 'rgba(0,0,0,0.24)';
    ctx.beginPath();
    ctx.ellipse(player.x + 17, player.y + player.h + 3, 12, 4, 0, 0, Math.PI * 2);
    ctx.fill();

    ctx.save();
    ctx.translate(player.x, player.y + bounce);

    ctx.fillStyle = '#2c4f95';
    ctx.fillRect(8, 17, 18, 24);
    ctx.fillStyle = '#f5caa2';
    ctx.fillRect(8, 4, 18, 14);

    ctx.fillStyle = '#f08a33';
    ctx.fillRect(4, 10, 26, 5);
    ctx.fillStyle = '#5a2e22';
    ctx.fillRect(5, 0, 24, 7);

    ctx.fillStyle = '#161412';
    if (!blink) {
      ctx.fillRect(12, 10, 3, 3);
      ctx.fillRect(20, 10, 3, 3);
    }
    ctx.fillRect(16, 14, 2, 1);

    ctx.fillStyle = '#24417a';
    ctx.fillRect(11, 41, 5, 7 + Math.max(0, legPhase));
    ctx.fillRect(18, 41, 5, 7 + Math.max(0, -legPhase));
    ctx.fillStyle = '#1b2743';
    ctx.fillRect(10, 48, 7, 3);
    ctx.fillRect(17, 48, 7, 3);

    ctx.fillStyle = '#f0b991';
    ctx.fillRect(4, 20, 4, 8);
    ctx.fillRect(26, 20, 4, 8);

    if (player.vy < -30) {
      ctx.fillStyle = '#f1a35e';
      ctx.fillRect(2, 18, 3, 11);
    }

    ctx.restore();
  }

  function drawMotes() {
    var i;
    for (i = 0; i < motes.length; i++) {
      var m = motes[i];
      var pulse = 0.35 + 0.35 * (Math.sin(frame * 3 + m.phase) + 1) * 0.5;
      ctx.fillStyle = 'rgba(255, 198, 112, ' + pulse + ')';
      ctx.beginPath();
      ctx.arc(m.x, m.y, m.r, 0, Math.PI * 2);
      ctx.fill();
    }
  }

  function drawPuffs() {
    var i;
    for (i = 0; i < puffs.length; i++) {
      var p = puffs[i];
      ctx.globalAlpha = Math.max(0, p.life * 1.8);
      var puffGrad = ctx.createRadialGradient(p.x, p.y, p.size * 0.2, p.x, p.y, p.size);
      puffGrad.addColorStop(0, '#fff8e7');
      puffGrad.addColorStop(1, 'rgba(255, 236, 201, 0)');
      ctx.fillStyle = puffGrad;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      ctx.fill();
      ctx.globalAlpha = 1;
    }
  }

  function drawOverlay() {
    if (!paused && !gameOver) return;
    ctx.fillStyle = 'rgba(0, 0, 0, 0.36)';
    ctx.fillRect(0, 0, W, H);

    ctx.fillStyle = 'rgba(20, 18, 16, 0.58)';
    ctx.fillRect(W / 2 - 170, H / 2 - 72, 340, 120);
    ctx.strokeStyle = 'rgba(255, 221, 176, 0.52)';
    ctx.strokeRect(W / 2 - 170, H / 2 - 72, 340, 120);

    ctx.fillStyle = '#fff';
    ctx.font = '700 40px Merriweather, serif';
    ctx.textAlign = 'center';
    ctx.fillText(paused ? 'Paused' : 'Game Over', W / 2, H / 2 - 20);
    ctx.font = '600 16px JetBrains Mono, monospace';
    ctx.fillStyle = '#f8ddbe';
    ctx.fillText(paused ? 'Press P to resume' : 'Press R to run again', W / 2, H / 2 + 16);
  }

  function render() {
    ctx.clearRect(0, 0, W, H);
    drawSky();

    var i;
    for (i = 0; i < clouds.length; i++) drawCloud(clouds[i]);
    drawHills();
    drawMotes();
    drawGround();
    for (i = 0; i < platforms.length; i++) drawPlatform(platforms[i]);
    for (i = 0; i < leaves.length; i++) drawLeaf(leaves[i]);
    for (i = 0; i < slimes.length; i++) drawSlime(slimes[i]);
    drawPlayer();
    drawPuffs();

    var vignette = ctx.createRadialGradient(W * 0.5, H * 0.5, 90, W * 0.5, H * 0.5, W * 0.72);
    vignette.addColorStop(0, 'rgba(0,0,0,0)');
    vignette.addColorStop(1, 'rgba(0,0,0,0.18)');
    ctx.fillStyle = vignette;
    ctx.fillRect(0, 0, W, H);

    drawOverlay();
  }

  var last = 0;
  function loop(ts) {
    var dt = Math.min(0.033, (ts - last) / 1000 || 0.016);
    last = ts;
    update(dt);
    render();
    requestAnimationFrame(loop);
  }

  window.addEventListener('keydown', function (e) {
    var k = e.key.toLowerCase();
    if (k === ' ' || k === 'w' || k === 'arrowup') {
      e.preventDefault();
      jump();
    } else if (k === 'r') {
      resetWorld();
    } else if (k === 'p') {
      if (!gameOver) {
        paused = !paused;
        stateEl.textContent = paused ? 'Paused' : 'Running';
      }
    }
  });

  jumpBtn.addEventListener('pointerdown', function (e) {
    e.preventDefault();
    jump();
  });

  resetWorld();
  bestEl.textContent = String(best);
  requestAnimationFrame(loop);
})();
</script>
